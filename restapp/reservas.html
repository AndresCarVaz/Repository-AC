<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Reservas - Tavolo App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(-45deg, #c7c7c7, #d5e4ff, #ffffff, #a3a3a3);
      background-size: 400% 400%;
      animation: gradientMove 10s ease infinite;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      /* üé¨ Transici√≥n */
      transform: translateX(0);
      transition: transform 1.5s ease;
    }

    body.slide-out {
      transform: translateX(-100%);
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    h2 {
      color: #fff;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.6);
      margin-bottom: 20px;
    }

    .card-reserva {
      background: #fff;
      border-radius: 12px;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
      padding: 15px;
      margin: 10px;
      width: 300px;
      display: inline-block;
      vertical-align: top;
    }

    .acciones button {
      margin: 3px;
    }

    @media (max-width: 576px) {
      .card-reserva {
        width: 100% !important; /* resp de tarjetas ocupen todo el ancho en celular */
      }
    }

    /* Colores de estado */
    .estado-pendiente { border-left: 6px solid #ffc107; }
    .estado-confirmada { border-left: 6px solid #28a745; }
    .estado-cancelada { border-left: 6px solid #dc3545; }
    .estado-finalizada { border-left: 6px solid #007bff; }
    .estado-noshow { border-left: 6px solid #6c757d; }
  </style>
</head>

<button class="btn btn-danger mb-3" onclick="borrarTodo()">üóëÔ∏è Borrar Datos</button>

<script>
// --- Transici√≥n entre p√°ginas ---
function transicion(e, url) {
  e.preventDefault();
  document.body.classList.add("slide-out");
  setTimeout(() => { window.location.href = url; }, 500);
}

function borrarTodo() {
  if (confirm("¬øSeguro que quieres borrar toda la informaci√≥n guardada?")) {
    localStorage.clear();
    location.reload(); // refresca la p√°gina
  }
}
</script>

<body>
  <div class="mb-3">
    <a href="restapp.html" class="btn btn-light" onclick="transicion(event, 'restapp.html')">üè† Men√∫ Principal</a>
    <a href="reservas.html" class="btn btn-light" onclick="transicion(event, 'mesas.html')">üìÖ Mesas</a>
  </div>

  <h2>Gesti√≥n de Reservas</h2>

  <!-- üìå Mensajes de error/exito -->
  <div id="mensajeReserva" class="alert d-none"></div>

  <!-- Bot√≥n para abrir modal -->
  <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#modalReserva">‚ûï Crear Nueva Reserva</button>

  <!-- Modal para crear/editar reserva -->
  <div class="modal fade" id="modalReserva" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="formTitulo" class="modal-title">Crear Nueva Reserva</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <!-- formulario (igual que ya ten√≠as) -->
            <div class="col-md-4">
              <input type="text" id="nombreCliente" class="form-control" placeholder="Nombre del Cliente">
              <div class="invalid-feedback">El nombre del cliente es obligatorio</div>
            </div>
            <div class="col-md-2">
              <input type="number" id="numeroPersonas" class="form-control" placeholder="Personas">
              <div class="invalid-feedback">El n√∫mero de personas es obligatorio</div>
            </div>
            <div class="col-md-3">
              <input type="date" id="fechaReserva" class="form-control">
              <div class="invalid-feedback">La fecha de la reserva es obligatoria</div>
            </div>
            <div class="col-md-3">
              <input type="time" id="horaReserva" class="form-control">
              <div class="invalid-feedback">La hora de la reserva es obligatoria</div>
            </div>
            <div class="col-md-4">
              <select id="ocasionEspecial" class="form-select">
                <option value="">Ninguna</option>
                <option value="Cumplea√±os">Cumplea√±os</option>
                <option value="Aniversario">Aniversario</option>
                <option value="Reuni√≥n de Negocios">Reuni√≥n de Negocios</option>
                <option value="Graduaci√≥n">Graduaci√≥n</option>
                <option value="Boda">Boda</option>
                <option value="Cena Familiar">Cena Familiar</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
            <div class="col-md-4">
              <input type="text" id="notasAdicionales" class="form-control" placeholder="Notas adicionales (opcional)">
            </div>
            <div class="col-md-4">
              <select id="idMesaAsignada" class="form-select"></select>
              <div class="invalid-feedback">Debe seleccionar una mesa</div>
            </div>
            <div class="col-md-4">
              <select id="estado" class="form-select">
                <option value="Pendiente">Pendiente</option>
                <option value="Confirmada">Confirmada</option>
                <option value="Cancelada">Cancelada</option>
                <option value="Finalizada">Finalizada</option>
                <option value="No Show">No Show</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-success" id="btnGuardar" onclick="guardarReserva()">Guardar Reserva</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card p-3 mb-3 w-75">
    <!-- igual que ya ten√≠as -->
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label text-white">Filtrar por Fecha</label>
        <input type="date" id="filtroFecha" class="form-control" onchange="mostrarReservas()">
      </div>
      <div class="col-md-6">
        <label class="form-label text-white">Filtrar por Estado</label>
        <select id="filtroEstado" class="form-select" onchange="mostrarReservas()">
          <option value="">Todos</option>
          <option value="Pendiente">Pendiente</option>
          <option value="Confirmada">Confirmada</option>
          <option value="Cancelada">Cancelada</option>
          <option value="Finalizada">Finalizada</option>
          <option value="No Show">No Show</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Contenedor de reservas -->
  <div id="listaReservas" class="d-flex flex-wrap justify-content-center"></div>

  <script>
    if (!localStorage.getItem("reservas")) {
      localStorage.setItem("reservas", JSON.stringify([]));
    }
    let reservas = JSON.parse(localStorage.getItem("reservas"));
    let editIndex = null;

    /** RF4.5: Mapear ocasi√≥n especial con im√°genes **/
    const imagenesOcasion = {
      "Cumplea√±os": "/images/cumplea√±os.png",
      "Aniversario": "/images/aniversario.png",
      "Reuni√≥n de Negocios": "/images/reuniondenegocios.png",
      "Graduaci√≥n": "/images/graduacion.png",
      "Boda": "/images/boda.png",
      "Cena Familiar": "/images/familia.png",
      "Otro": "/images/otro.png",
      "": "/images/ninguna.png"
    };

    // üìå Funci√≥n para mostrar mensajes
    function mostrarMensaje(texto, tipo = "danger") {
      let mensajeDiv = document.getElementById("mensajeReserva");
      mensajeDiv.textContent = texto;
      mensajeDiv.className = "alert alert-" + tipo;
      mensajeDiv.classList.remove("d-none");
      setTimeout(() => mensajeDiv.classList.add("d-none"), 4000);
    }

    function cargarMesas() {
      let mesas = JSON.parse(localStorage.getItem("mesas")) || [];
      let selectMesa = document.getElementById("idMesaAsignada");
      selectMesa.innerHTML = "<option value=''>Selecciona ubicaci√≥n</option>";
      mesas.forEach(m => {
        // Mostrar mesas disponibles (puedes cambiar l√≥gica si quieres mostrar todas)
        if (m.estado === "disponible") {
          let opt = document.createElement("option");
          opt.value = m.id;
          opt.textContent = m.id + " (" + m.capacidad + " pers., " + m.ubicacion + ")";
          selectMesa.appendChild(opt);
        }
      });
    }

    function guardarReserva() {
      // referenciar campos
      let nombreCliente = document.getElementById("nombreCliente");
      let numeroPersonas = document.getElementById("numeroPersonas");
      let fechaReserva = document.getElementById("fechaReserva");
      let horaReserva = document.getElementById("horaReserva");
      let idMesaAsignada = document.getElementById("idMesaAsignada");

      // limpiar errores previos
      [nombreCliente, numeroPersonas, fechaReserva, horaReserva, idMesaAsignada].forEach(el => el.classList.remove("is-invalid"));
      let valido = true;

      // validaciones b√°sicas
      if (!nombreCliente.value.trim()) { nombreCliente.classList.add("is-invalid"); valido = false; }
      if (!numeroPersonas.value || parseInt(numeroPersonas.value) <= 0) { numeroPersonas.classList.add("is-invalid"); valido = false; }
      if (!fechaReserva.value) { fechaReserva.classList.add("is-invalid"); valido = false; }
      if (!horaReserva.value) { horaReserva.classList.add("is-invalid"); valido = false; }
      if (!idMesaAsignada.value) { idMesaAsignada.classList.add("is-invalid"); valido = false; }
      if (!valido) return;

      /** RF3.3: Validar fecha futura **/
      let hoy = new Date().toISOString().split("T")[0];
      if (fechaReserva.value < hoy) {
        fechaReserva.classList.add("is-invalid");
        fechaReserva.nextElementSibling.textContent = "La fecha no puede ser anterior a hoy";
        return;
      }

      /** RF3.4: Validar hora entre 08:00 y 20:00 **/
      if (horaReserva.value < "08:00" || horaReserva.value > "20:00") {
        horaReserva.classList.add("is-invalid");
        horaReserva.nextElementSibling.textContent = "La hora debe estar entre 08:00 y 20:00";
        return;
      }

      /** RF3.2: Validar capacidad de mesa **/
      let mesas = JSON.parse(localStorage.getItem("mesas")) || [];
      let mesaSeleccionada = mesas.find(m => m.id === idMesaAsignada.value);
      if (mesaSeleccionada && parseInt(numeroPersonas.value) > parseInt(mesaSeleccionada.capacidad)) {
        numeroPersonas.classList.add("is-invalid");
        numeroPersonas.nextElementSibling.textContent =
          `La mesa seleccionada soporta m√°ximo ${mesaSeleccionada.capacidad} personas`;
        return;
      }

      /** RF3.5: Validar disponibilidad de mesa con bloqueos de 2 horas **/
      // calcular ventana nueva
      let nuevaHora = horaReserva.value;
      let fecha = fechaReserva.value;

      let conflicto = reservas.some((r, idx) => {
        // ignorar la reserva que estamos editando
        if (editIndex !== null && idx === editIndex) return false;
        if (r.idMesaAsignada !== idMesaAsignada.value) return false;
        if (r.fechaReserva !== fecha) return false;
        if (r.estado === "Cancelada" || r.estado === "Finalizada") return false;

        // convertir a minutos para comparar (existente)
        let partsExist = r.horaReserva.split(":");
        if (partsExist.length < 2) return false;
        let inicioExistente = parseInt(partsExist[0], 10) * 60 + parseInt(partsExist[1], 10);
        let finExistente = inicioExistente + 120; // +2 horas

        // nueva
        let partsNew = nuevaHora.split(":");
        let inicioNuevo = parseInt(partsNew[0], 10) * 60 + parseInt(partsNew[1], 10);
        let finNuevo = inicioNuevo + 120;

        // si se solapan
        return !(finNuevo <= inicioExistente || inicioNuevo >= finExistente);
      });

      if (conflicto) {
        idMesaAsignada.classList.add("is-invalid");
        idMesaAsignada.nextElementSibling.textContent = "La mesa ya est√° reservada en esa franja de 2 horas";
        mostrarMensaje("‚ö†Ô∏è Esta mesa ya est√° reservada en esa franja de 2 horas.", "danger");
        return;
      }

      // armar objeto reserva
      let reserva = {
        idReserva: editIndex !== null ? reservas[editIndex].idReserva : Date.now(),
        nombreCliente: nombreCliente.value.trim(),
        numeroPersonas: numeroPersonas.value.trim(),
        fechaReserva: fechaReserva.value,
        horaReserva: horaReserva.value,
        ocasionEspecial: document.getElementById("ocasionEspecial").value,
        notasAdicionales: document.getElementById("notasAdicionales").value.trim(),
        idMesaAsignada: idMesaAsignada.value,
        estado: document.getElementById("estado").value
      };

      if (editIndex !== null) {
        reservas[editIndex] = reserva;
        editIndex = null;
        document.getElementById("btnGuardar").textContent = "Guardar Reserva";
        document.getElementById("formTitulo").textContent = "Crear Nueva Reserva";
      } else {
        reservas.push(reserva);
      }

      // persistir
      localStorage.setItem("reservas", JSON.stringify(reservas));
      mostrarReservas();
      limpiarFormulario();

      let modal = bootstrap.Modal.getInstance(document.getElementById("modalReserva"));
      if (modal) modal.hide();

      mostrarMensaje("‚úÖ Reserva guardada correctamente.", "success");
    }

    function mostrarReservas() {
      // actualizar variable local desde storage para evitar desincron√≠a
      reservas = JSON.parse(localStorage.getItem("reservas") || "[]");

      let contenedor = document.getElementById("listaReservas");
      contenedor.innerHTML = "";

      let filtroFecha = document.getElementById("filtroFecha").value;
      let filtroEstado = document.getElementById("filtroEstado").value;

      reservas
        .filter(r => {
          let ok = true;
          if (filtroFecha && r.fechaReserva !== filtroFecha) ok = false;
          if (filtroEstado && r.estado !== filtroEstado) ok = false;
          return ok;
        })
        .forEach((r, i) => {
          let estadoClase = "estado-" + r.estado.toLowerCase().replace(" ", "");
          let card = document.createElement("div");
          card.className = "card-reserva " + estadoClase;

          /** RF4.5: Mostrar imagen seg√∫n ocasi√≥n especial **/
          let img = `<img src="${imagenesOcasion[r.ocasionEspecial] || 'images/ninguna.png'}" class="img-fluid mb-2">`;

          card.innerHTML = `
            ${img}
            <h5>Reserva #${r.idReserva}</h5>
            <p><b>Cliente:</b> ${r.nombreCliente}</p>
            <p><b>Personas:</b> ${r.numeroPersonas}</p>
            <p><b>Fecha:</b> ${r.fechaReserva}</p>
            <p><b>Hora:</b> ${r.horaReserva}</p>
            <p><b>Mesa:</b> ${r.idMesaAsignada}</p>
            <p><b>Ocasi√≥n:</b> ${r.ocasionEspecial}</p>
            <p><b>Estado:</b> ${r.estado}</p>
            <div class="acciones">
              <button class="btn btn-primary btn-sm" onclick="editarReserva(${i})">Editar</button>
              <button class="btn btn-info btn-sm" onclick="pagarReserva(${i})">Pagar</button>
              <button class="btn btn-danger btn-sm" onclick="eliminarReserva(${i})">Eliminar</button>
            </div>
          `;
          contenedor.appendChild(card);
        });
    }

    function eliminarReserva(index) {
      reservas.splice(index, 1);
      localStorage.setItem("reservas", JSON.stringify(reservas));
      mostrarReservas();
      mostrarMensaje("Reserva eliminada.", "danger");
    }

    function editarReserva(index) {
      let r = reservas[index];
      document.getElementById("nombreCliente").value = r.nombreCliente;
      document.getElementById("numeroPersonas").value = r.numeroPersonas;
      document.getElementById("fechaReserva").value = r.fechaReserva;
      document.getElementById("horaReserva").value = r.horaReserva;
      document.getElementById("ocasionEspecial").value = r.ocasionEspecial;
      document.getElementById("notasAdicionales").value = r.notasAdicionales;
      // si la mesa no aparece en el select (estaba ocupada), la agregamos temporalmente para poder editar
      let selectMesa = document.getElementById("idMesaAsignada");
      if (![...selectMesa.options].some(opt => opt.value === r.idMesaAsignada)) {
        let opt = document.createElement("option");
        opt.value = r.idMesaAsignada;
        opt.textContent = r.idMesaAsignada + " (preseleccionada)";
        selectMesa.appendChild(opt);
      }
      document.getElementById("idMesaAsignada").value = r.idMesaAsignada;
      document.getElementById("estado").value = r.estado;

      editIndex = index;
      document.getElementById("btnGuardar").textContent = "Actualizar Reserva";
      document.getElementById("formTitulo").textContent = "Editar Reserva";

      let modal = new bootstrap.Modal(document.getElementById("modalReserva"));
      modal.show();
    }

    /** RF4.6, REF 4.1.2 y REF 4.1.3: Pagar reserva cambia a Finalizada y libera la mesa **/
    function pagarReserva(index) {
      reservas[index].estado = "Finalizada";

      let mesas = JSON.parse(localStorage.getItem("mesas")) || [];
      let mesa = mesas.find(m => m.id === reservas[index].idMesaAsignada);
      if (mesa) mesa.estado = "disponible";

      localStorage.setItem("mesas", JSON.stringify(mesas));
      localStorage.setItem("reservas", JSON.stringify(reservas));
      mostrarReservas();
      mostrarMensaje("‚úÖ Reserva pagada, mesa liberada.", "success");
    }

    function limpiarFormulario() {
      document.getElementById("nombreCliente").value = "";
      document.getElementById("numeroPersonas").value = "";
      document.getElementById("fechaReserva").value = "";
      document.getElementById("horaReserva").value = "";
      document.getElementById("ocasionEspecial").value = "";
      document.getElementById("notasAdicionales").value = "";
      document.getElementById("idMesaAsignada").value = "";
      document.getElementById("estado").value = "Pendiente";
      // limpiar validaciones visuales
      [ "nombreCliente","numeroPersonas","fechaReserva","horaReserva","idMesaAsignada" ].forEach(id => {
        let el = document.getElementById(id);
        if (el) el.classList.remove("is-invalid");
      });
    }

    // Inicial
    cargarMesas();
    mostrarReservas();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // üëá Script que abre el modal si vienes desde Mesas (debe ir despu√©s de bootstrap)
  window.addEventListener("DOMContentLoaded", () => {
    let mesaSel = localStorage.getItem("mesaSeleccionada");
    let abrirModal = localStorage.getItem("abrirModalReserva");

    if (mesaSel && abrirModal === "true") {
      cargarMesas(); // refresca el select de mesas
      // si la mesa no est√° en el select (ej: no disponible), la agregamos temporalmente
      let select = document.getElementById("idMesaAsignada");
      if (![...select.options].some(opt => opt.value === mesaSel)) {
        let opt = document.createElement("option");
        opt.value = mesaSel;
        opt.textContent = mesaSel + " (preseleccionada)";
        select.appendChild(opt);
      }

      document.getElementById("idMesaAsignada").value = mesaSel; // preselecciona mesa

      // abrir modal autom√°ticamente
      let modal = new bootstrap.Modal(document.getElementById("modalReserva"));
      modal.show();

      // limpiar la marca para que no se vuelva a abrir siempre
      localStorage.removeItem("abrirModalReserva");
      localStorage.removeItem("mesaSeleccionada");
    }
  });
  </script>

</body>
</html>
